<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HueHue Simple Debug</title>
    <style>
        body {
            font-family: monospace;
            background: #000;
            color: #0f0;
            padding: 20px;
        }
        .section {
            margin: 20px 0;
            padding: 10px;
            border: 1px solid #0f0;
        }
        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 10px;
            cursor: pointer;
            margin: 5px;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .error { color: #f00; }
        .success { color: #0f0; }
        .warning { color: #ff0; }
    </style>
</head>
<body>
    <h1>HueHue Firebase Debug</h1>
    
    <div class="section">
        <h2>1. Direct Firebase Test</h2>
        <button onclick="testFirebaseDirectly()">Test Firebase Connection</button>
        <div id="firebaseTest"></div>
    </div>
    
    <div class="section">
        <h2>2. Current Data in Firebase</h2>
        <button onclick="checkCurrentData()">Check Current Data</button>
        <div id="currentData"></div>
    </div>
    
    <div class="section">
        <h2>3. VPS Status</h2>
        <button onclick="checkVPSStatus()">Check VPS Status</button>
        <div id="vpsStatus"></div>
    </div>
    
    <div class="section">
        <h2>4. Test Real-time Updates</h2>
        <button onclick="testRealtimeUpdates()">Start Real-time Test</button>
        <button onclick="stopRealtimeTest()">Stop Test</button>
        <div id="realtimeTest"></div>
    </div>
    
    <div class="section">
        <h2>5. Console Output</h2>
        <pre id="console"></pre>
    </div>

    <script type="module">
        // Import Firebase modules directly
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getFirestore, 
            collection, 
            doc, 
            getDoc, 
            getDocs,
            query,
            orderBy,
            limit,
            onSnapshot
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyCVmv46KsUATB3HkzJUKEHQHuGefhJfTMN",
            authDomain: "huehue-signals.firebaseapp.com",
            projectId: "huehue-signals",
            storageBucket: "huehue-signals.firebasestorage.app",
            messagingSenderId: "151713753111",
            appId: "1:151713753111:web:86dd494a47db4f775a9452"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let unsubscribers = [];
        
        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
            console.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            console.scrollTop = console.scrollHeight;
        }
        
        window.testFirebaseDirectly = async function() {
            const output = document.getElementById('firebaseTest');
            try {
                log('Testing Firebase connection...');
                
                // Try to read a test document
                const testDoc = doc(db, 'test', 'connection');
                const docSnap = await getDoc(testDoc);
                
                output.innerHTML = '<span class="success">✅ Firebase connected successfully!</span>';
                log('Firebase connection successful', 'success');
                
            } catch (error) {
                output.innerHTML = `<span class="error">❌ Firebase error: ${error.message}</span>`;
                log(`Firebase error: ${error.message}`, 'error');
            }
        }
        
        window.checkCurrentData = async function() {
            const output = document.getElementById('currentData');
            output.innerHTML = 'Loading...';
            
            try {
                // Check prices
                const symbols = ['XAUUSD', 'USDJPY'];
                let html = '<h3>Prices:</h3>';
                
                for (const symbol of symbols) {
                    const priceDoc = await getDoc(doc(db, 'prices', symbol));
                    if (priceDoc.exists()) {
                        const data = priceDoc.data();
                        const age = Date.now() - data.timestamp;
                        html += `<div>${symbol}: $${data.price} (${Math.round(age/1000)}s ago)</div>`;
                        log(`${symbol} price: ${data.price}`);
                    } else {
                        html += `<div class="error">${symbol}: No data</div>`;
                    }
                }
                
                // Check analysis
                html += '<h3>Analysis:</h3>';
                for (const symbol of symbols) {
                    const analysisDoc = await getDoc(doc(db, 'analysis', symbol));
                    if (analysisDoc.exists()) {
                        const data = analysisDoc.data();
                        html += `<div>${symbol}: ${data.bias} (${data.strength}/6)</div>`;
                        log(`${symbol} analysis: ${data.bias} ${data.strength}/6`);
                    } else {
                        html += `<div class="error">${symbol}: No analysis</div>`;
                    }
                }
                
                // Check recent signals
                const signalsQuery = query(
                    collection(db, 'signals'),
                    orderBy('timestamp', 'desc'),
                    limit(5)
                );
                const signalsSnap = await getDocs(signalsQuery);
                
                html += '<h3>Recent Signals:</h3>';
                signalsSnap.forEach((doc) => {
                    const signal = doc.data();
                    const time = new Date(signal.timestamp).toLocaleString();
                    html += `<div>${signal.symbol} ${signal.action} - ${time}</div>`;
                });
                
                output.innerHTML = html;
                
            } catch (error) {
                output.innerHTML = `<span class="error">Error: ${error.message}</span>`;
                log(`Error checking data: ${error.message}`, 'error');
            }
        }
        
        window.checkVPSStatus = async function() {
            const output = document.getElementById('vpsStatus');
            output.innerHTML = 'Loading...';
            
            try {
                const generatorDoc = await getDoc(doc(db, 'system', 'generator'));
                
                if (generatorDoc.exists()) {
                    const data = generatorDoc.data();
                    const lastHeartbeat = new Date(data.lastHeartbeat);
                    const age = Date.now() - data.lastHeartbeat;
                    const isActive = age < 120000;
                    
                    let html = `<h3>VPS Generator Status:</h3>`;
                    html += `<div>Status: ${data.status} <span class="${isActive ? 'success' : 'error'}">(${isActive ? 'ACTIVE' : 'INACTIVE'})</span></div>`;
                    html += `<div>Type: ${data.type}</div>`;
                    html += `<div>Last Heartbeat: ${lastHeartbeat.toLocaleString()} (${Math.round(age/1000)}s ago)</div>`;
                    
                    if (!isActive) {
                        html += `<div class="warning">⚠️ VPS appears to be down!</div>`;
                        log('VPS is not active!', 'error');
                    } else {
                        log('VPS is active', 'success');
                    }
                    
                    output.innerHTML = html;
                } else {
                    output.innerHTML = '<span class="error">No VPS generator status found</span>';
                    log('No VPS status in Firebase', 'error');
                }
                
            } catch (error) {
                output.innerHTML = `<span class="error">Error: ${error.message}</span>`;
                log(`Error checking VPS: ${error.message}`, 'error');
            }
        }
        
        window.testRealtimeUpdates = function() {
            const output = document.getElementById('realtimeTest');
            output.innerHTML = '<div>Listening for updates...</div>';
            
            // Clear previous listeners
            stopRealtimeTest();
            
            // Listen to XAUUSD price
            const priceUnsub = onSnapshot(doc(db, 'prices', 'XAUUSD'), (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    const time = new Date().toLocaleTimeString();
                    output.innerHTML += `<div class="success">[${time}] XAUUSD price updated: $${data.price}</div>`;
                    log(`Real-time update: XAUUSD $${data.price}`, 'success');
                }
            });
            
            unsubscribers.push(priceUnsub);
            
            // Listen to analysis
            const analysisUnsub = onSnapshot(doc(db, 'analysis', 'XAUUSD'), (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    const time = new Date().toLocaleTimeString();
                    output.innerHTML += `<div class="success">[${time}] XAUUSD analysis: ${data.bias} (${data.strength}/6)</div>`;
                    log(`Real-time update: Analysis ${data.bias}`, 'success');
                }
            });
            
            unsubscribers.push(analysisUnsub);
            
            log('Started real-time listeners', 'success');
        }
        
        window.stopRealtimeTest = function() {
            unsubscribers.forEach(unsub => unsub());
            unsubscribers = [];
            log('Stopped real-time listeners');
        }
        
        // Auto-run basic test on load
        window.addEventListener('load', () => {
            log('Debug tool loaded');
            testFirebaseDirectly();
        });
    </script>
</body>
</html>