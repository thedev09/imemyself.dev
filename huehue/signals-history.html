<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HueHue - Signals History & Analytics</title>
    <link rel="stylesheet" href="css/main.css">
    <style>
        .history-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .back-btn {
            background: rgba(0, 212, 255, 0.2);
            border: 1px solid #00d4ff;
            color: #00d4ff;
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: #00d4ff;
            color: #000;
        }

        .filters-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            color: #a0a0a0;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .filter-group select,
        .filter-group input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card-large {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-card-large .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-card-large .stat-label {
            color: #a0a0a0;
            font-size: 1em;
        }

        .signals-table {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 0;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }

        .table-header {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px 20px;
            display: grid;
            grid-template-columns: 100px 120px 120px 100px 100px 120px 120px 1fr;
            gap: 15px;
            font-weight: bold;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .table-row {
            padding: 15px 20px;
            display: grid;
            grid-template-columns: 100px 120px 120px 100px 100px 120px 120px 1fr;
            gap: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .table-row:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .table-row.signal-buy {
            border-left: 4px solid #00ff88;
        }

        .table-row.signal-sell {
            border-left: 4px solid #ff4757;
        }

        .status-pending { color: #ffa502; }
        .status-win { color: #00ff88; }
        .status-loss { color: #ff4757; }

        .strength-badge {
            background: rgba(0, 212, 255, 0.2);
            color: #00d4ff;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 30px;
            gap: 10px;
        }

        .pagination button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pagination button:hover:not(:disabled) {
            background: rgba(0, 212, 255, 0.2);
            border-color: #00d4ff;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .active {
            background: #00d4ff;
            color: #000;
        }

        .monthly-stats {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .monthly-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .month-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .month-header {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #00d4ff;
        }

        .month-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
        }

        .export-section {
            text-align: center;
            margin-top: 30px;
        }

        .export-btn {
            background: linear-gradient(45deg, #00d4ff, #ff6b35);
            border: none;
            color: white;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 212, 255, 0.3);
        }
    </style>
</head>
<body>
    <div class="history-container">
        <div class="history-header">
            <h1>üìä Signals History & Analytics</h1>
            <a href="index.html" class="back-btn">‚Üê Back to Dashboard</a>
        </div>

        <!-- Filters Section -->
        <div class="filters-section">
            <div class="filter-group">
                <label>Symbol</label>
                <select id="symbolFilter">
                    <option value="all">All Symbols</option>
                    <option value="XAUUSD">XAUUSD</option>
                    <option value="USDJPY">USDJPY</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Action</label>
                <select id="actionFilter">
                    <option value="all">All Actions</option>
                    <option value="BUY">BUY</option>
                    <option value="SELL">SELL</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Date From</label>
                <input type="date" id="dateFromFilter">
            </div>
            <div class="filter-group">
                <label>Date To</label>
                <input type="date" id="dateToFilter">
            </div>
            <div class="filter-group">
                <label>Min Strength</label>
                <select id="strengthFilter">
                    <option value="0">All Strengths</option>
                    <option value="4">4+ Strong</option>
                    <option value="5">5+ Very Strong</option>
                    <option value="6">6 Perfect</option>
                </select>
            </div>
        </div>

        <!-- Stats Overview -->
        <div class="stats-overview">
            <div class="stat-card-large">
                <div class="stat-number" style="color: #00ff88;" id="totalSignals">0</div>
                <div class="stat-label">Total Signals</div>
            </div>
            <div class="stat-card-large">
                <div class="stat-number" style="color: #00d4ff;" id="winRateDisplay">0%</div>
                <div class="stat-label">Overall Win Rate</div>
            </div>
            <div class="stat-card-large">
                <div class="stat-number" style="color: #ffa502;" id="avgStrengthDisplay">0</div>
                <div class="stat-label">Average Strength</div>
            </div>
            <div class="stat-card-large">
                <div class="stat-number" style="color: #ff6b35;" id="totalPnLDisplay">$0</div>
                <div class="stat-label">Total P&L</div>
            </div>
        </div>

        <!-- Monthly Performance -->
        <div class="monthly-stats">
            <h2>üìà Monthly Performance</h2>
            <div class="monthly-grid" id="monthlyGrid">
                <!-- Monthly cards will be populated here -->
            </div>
        </div>

        <!-- Signals Table -->
        <div class="signals-table">
            <div class="table-header">
                <div>Date</div>
                <div>Time</div>
                <div>Symbol</div>
                <div>Action</div>
                <div>Strength</div>
                <div>Entry Price</div>
                <div>Status</div>
                <div>P&L</div>
            </div>
            <div id="signalsTableBody">
                <!-- Table rows will be populated here -->
            </div>
        </div>

        <!-- Pagination -->
        <div class="pagination" id="pagination">
            <!-- Pagination will be populated here -->
        </div>

        <!-- Export Section -->
        <div class="export-section">
            <button class="export-btn" onclick="exportSignals()">üì• Export to CSV</button>
        </div>
    </div>

    <!-- Load Firebase and Core Scripts -->
    <script src="firebase-config.js"></script>
    <script>
        class SignalsHistory {
            constructor() {
                this.signals = [];
                this.filteredSignals = [];
                this.currentPage = 1;
                this.pageSize = 50;
                this.firebaseStorage = null;
            }

            async initialize() {
                // Wait for Firebase
                await this.waitForFirebase();
                
                // Load all signals
                await this.loadAllSignals();
                
                // Setup filters
                this.setupFilters();
                
                // Initial render
                this.renderPage();
            }

            async waitForFirebase() {
                let attempts = 0;
                while (!window.firebaseStorage && attempts < 30) {
                    await this.sleep(100);
                    attempts++;
                }
                this.firebaseStorage = window.firebaseStorage;
            }

            async loadAllSignals() {
                if (!this.firebaseStorage) return;
                
                try {
                    // Load large number of signals (500)
                    this.signals = await this.firebaseStorage.getSignals(500);
                    
                    // Add simulated status and P&L for demo
                    this.signals = this.signals.map(signal => ({
                        ...signal,
                        status: this.getRandomStatus(),
                        pnl: this.calculateRandomPnL(signal)
                    }));
                    
                    this.filteredSignals = [...this.signals];
                    console.log(`üìä Loaded ${this.signals.length} signals from Firebase`);
                    
                } catch (error) {
                    console.error('Failed to load signals:', error);
                    // Generate demo data
                    this.signals = this.generateDemoSignals();
                    this.filteredSignals = [...this.signals];
                }
            }

            generateDemoSignals() {
                const signals = [];
                const symbols = ['XAUUSD', 'USDJPY'];
                const actions = ['BUY', 'SELL'];
                
                for (let i = 0; i < 100; i++) {
                    const date = new Date();
                    date.setDate(date.getDate() - Math.floor(Math.random() * 90));
                    
                    const signal = {
                        id: `demo_${i}`,
                        symbol: symbols[Math.floor(Math.random() * symbols.length)],
                        action: actions[Math.floor(Math.random() * actions.length)],
                        strength: Math.floor(Math.random() * 3) + 4, // 4-6
                        entry: symbols[0] === 'XAUUSD' ? 2000 + Math.random() * 100 : 150 + Math.random() * 2,
                        timestamp: date.getTime(),
                        status: this.getRandomStatus(),
                        pnl: this.calculateRandomPnL()
                    };
                    
                    signals.push(signal);
                }
                
                return signals.sort((a, b) => b.timestamp - a.timestamp);
            }

            getRandomStatus() {
                const statuses = ['pending', 'win', 'loss'];
                const weights = [0.2, 0.6, 0.2]; // 60% win rate
                const random = Math.random();
                
                if (random < weights[0]) return 'pending';
                if (random < weights[0] + weights[1]) return 'win';
                return 'loss';
            }

            calculateRandomPnL(signal) {
                if (!signal) return 0;
                
                const baseAmount = 100;
                if (signal.status === 'pending') return 0;
                if (signal.status === 'win') return baseAmount + Math.random() * 200;
                return -(baseAmount + Math.random() * 100);
            }

            setupFilters() {
                const filters = ['symbolFilter', 'actionFilter', 'dateFromFilter', 'dateToFilter', 'strengthFilter'];
                
                filters.forEach(filterId => {
                    const element = document.getElementById(filterId);
                    if (element) {
                        element.addEventListener('change', () => this.applyFilters());
                    }
                });

                // Set default date range (last 30 days)
                const today = new Date();
                const monthAgo = new Date();
                monthAgo.setDate(today.getDate() - 30);
                
                document.getElementById('dateToFilter').value = today.toISOString().split('T')[0];
                document.getElementById('dateFromFilter').value = monthAgo.toISOString().split('T')[0];
            }

            applyFilters() {
                let filtered = [...this.signals];
                
                // Symbol filter
                const symbol = document.getElementById('symbolFilter').value;
                if (symbol !== 'all') {
                    filtered = filtered.filter(s => s.symbol === symbol);
                }
                
                // Action filter
                const action = document.getElementById('actionFilter').value;
                if (action !== 'all') {
                    filtered = filtered.filter(s => s.action === action);
                }
                
                // Date filters
                const dateFrom = document.getElementById('dateFromFilter').value;
                const dateTo = document.getElementById('dateToFilter').value;
                
                if (dateFrom) {
                    const fromTime = new Date(dateFrom).getTime();
                    filtered = filtered.filter(s => s.timestamp >= fromTime);
                }
                
                if (dateTo) {
                    const toTime = new Date(dateTo).getTime() + 24 * 60 * 60 * 1000; // End of day
                    filtered = filtered.filter(s => s.timestamp <= toTime);
                }
                
                // Strength filter
                const minStrength = parseInt(document.getElementById('strengthFilter').value);
                if (minStrength > 0) {
                    filtered = filtered.filter(s => s.strength >= minStrength);
                }
                
                this.filteredSignals = filtered;
                this.currentPage = 1;
                this.renderPage();
            }

            renderPage() {
                this.renderStats();
                this.renderMonthlyStats();
                this.renderTable();
                this.renderPagination();
            }

            renderStats() {
                const signals = this.filteredSignals;
                const wins = signals.filter(s => s.status === 'win').length;
                const total = signals.filter(s => s.status !== 'pending').length;
                const winRate = total > 0 ? (wins / total * 100).toFixed(1) : 0;
                const avgStrength = signals.length > 0 ? (signals.reduce((sum, s) => sum + s.strength, 0) / signals.length).toFixed(1) : 0;
                const totalPnL = signals.reduce((sum, s) => sum + (s.pnl || 0), 0);
                
                document.getElementById('totalSignals').textContent = signals.length;
                document.getElementById('winRateDisplay').textContent = winRate + '%';
                document.getElementById('avgStrengthDisplay').textContent = avgStrength;
                document.getElementById('totalPnLDisplay').textContent = '$' + totalPnL.toFixed(0);
            }

            renderMonthlyStats() {
                const monthlyData = {};
                
                this.filteredSignals.forEach(signal => {
                    const date = new Date(signal.timestamp);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = {
                            signals: 0,
                            wins: 0,
                            losses: 0,
                            pnl: 0
                        };
                    }
                    
                    monthlyData[monthKey].signals++;
                    if (signal.status === 'win') monthlyData[monthKey].wins++;
                    if (signal.status === 'loss') monthlyData[monthKey].losses++;
                    monthlyData[monthKey].pnl += signal.pnl || 0;
                });
                
                const monthlyGrid = document.getElementById('monthlyGrid');
                monthlyGrid.innerHTML = '';
                
                Object.entries(monthlyData)
                    .sort((a, b) => b[0].localeCompare(a[0]))
                    .slice(0, 6)
                    .forEach(([month, data]) => {
                        const winRate = data.wins + data.losses > 0 ? ((data.wins / (data.wins + data.losses)) * 100).toFixed(1) : 0;
                        
                        const monthCard = document.createElement('div');
                        monthCard.className = 'month-card';
                        monthCard.innerHTML = `
                            <div class="month-header">${this.formatMonth(month)}</div>
                            <div class="month-stats">
                                <span>Signals: ${data.signals}</span>
                                <span>Win Rate: ${winRate}%</span>
                                <span>P&L: $${data.pnl.toFixed(0)}</span>
                            </div>
                        `;
                        monthlyGrid.appendChild(monthCard);
                    });
            }

            renderTable() {
                const start = (this.currentPage - 1) * this.pageSize;
                const end = start + this.pageSize;
                const pageSignals = this.filteredSignals.slice(start, end);
                
                const tableBody = document.getElementById('signalsTableBody');
                tableBody.innerHTML = '';
                
                pageSignals.forEach(signal => {
                    const row = document.createElement('div');
                    row.className = `table-row signal-${signal.action.toLowerCase()}`;
                    
                    const date = new Date(signal.timestamp);
                    const dateStr = date.toLocaleDateString();
                    const timeStr = date.toLocaleTimeString();
                    
                    row.innerHTML = `
                        <div>${dateStr}</div>
                        <div>${timeStr}</div>
                        <div>${signal.symbol}</div>
                        <div>${signal.action}</div>
                        <div><span class="strength-badge">${signal.strength}/6</span></div>
                        <div>${this.formatPrice(signal.symbol, signal.entry || 0)}</div>
                        <div class="status-${signal.status}">${signal.status.toUpperCase()}</div>
                        <div class="${signal.pnl >= 0 ? 'status-win' : 'status-loss'}">$${(signal.pnl || 0).toFixed(0)}</div>
                    `;
                    
                    tableBody.appendChild(row);
                });
            }

            renderPagination() {
                const totalPages = Math.ceil(this.filteredSignals.length / this.pageSize);
                const pagination = document.getElementById('pagination');
                pagination.innerHTML = '';
                
                // Previous button
                const prevBtn = document.createElement('button');
                prevBtn.textContent = '‚Üê Previous';
                prevBtn.disabled = this.currentPage === 1;
                prevBtn.onclick = () => this.goToPage(this.currentPage - 1);
                pagination.appendChild(prevBtn);
                
                // Page numbers
                const startPage = Math.max(1, this.currentPage - 2);
                const endPage = Math.min(totalPages, startPage + 4);
                
                for (let i = startPage; i <= endPage; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.textContent = i;
                    pageBtn.className = i === this.currentPage ? 'active' : '';
                    pageBtn.onclick = () => this.goToPage(i);
                    pagination.appendChild(pageBtn);
                }
                
                // Next button
                const nextBtn = document.createElement('button');
                nextBtn.textContent = 'Next ‚Üí';
                nextBtn.disabled = this.currentPage === totalPages;
                nextBtn.onclick = () => this.goToPage(this.currentPage + 1);
                pagination.appendChild(nextBtn);
            }

            goToPage(page) {
                this.currentPage = page;
                this.renderTable();
                this.renderPagination();
            }

            formatMonth(monthKey) {
                const [year, month] = monthKey.split('-');
                const date = new Date(year, month - 1);
                return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
            }

            formatPrice(symbol, price) {
                if (symbol === 'XAUUSD') {
                    return `$${price.toFixed(2)}`;
                } else if (symbol === 'USDJPY') {
                    return `¬•${price.toFixed(3)}`;
                }
                return price.toFixed(4);
            }

            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // Export function
        function exportSignals() {
            const history = window.signalsHistory;
            if (!history || !history.filteredSignals.length) {
                alert('No signals to export');
                return;
            }
            
            const csvContent = history.filteredSignals.map(signal => {
                const date = new Date(signal.timestamp);
                return [
                    date.toLocaleDateString(),
                    date.toLocaleTimeString(),
                    signal.symbol,
                    signal.action,
                    signal.strength,
                    signal.entry || 0,
                    signal.status,
                    signal.pnl || 0
                ].join(',');
            });
            
            csvContent.unshift('Date,Time,Symbol,Action,Strength,Entry,Status,PnL');
            
            const blob = new Blob([csvContent.join('\n')], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `huehue-signals-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', async () => {
            window.signalsHistory = new SignalsHistory();
            await window.signalsHistory.initialize();
        });
    </script>
</body>
</html>